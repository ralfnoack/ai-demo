<?php

use App\Blog\Chat;
use Symfony\AI\Agent\MockAgent;
use Symfony\AI\Platform\Message\AssistantMessage;
use Symfony\AI\Platform\Message\Content\Text;
use Symfony\AI\Platform\Message\MessageBag;
use Symfony\AI\Platform\Message\SystemMessage;
use Symfony\AI\Platform\Message\UserMessage;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\RequestStack;
use Symfony\Component\HttpFoundation\Session\Session;
use Symfony\Component\HttpFoundation\Session\Storage\MockArraySessionStorage;



test('load messages returns default system message', function () {


    $agent = new MockAgent();
    $chat = createChat($agent);

    $messages = $chat->loadMessages();

    expect($messages)->toBeInstanceOf(MessageBag::class);
    expect($messages->getMessages())->toHaveCount(1);

    $systemMessage = $messages->getMessages()[0];
    expect($systemMessage)->toBeInstanceOf(SystemMessage::class);
    $content = $systemMessage->getContent();
    expect($content)->toBeString();
    expect($content)->toContain('helpful assistant');
    expect($content)->toContain('similarity_search');
});

test('submit message adds user message and agent response', function () {
    $agent = new MockAgent([
        'What is Symfony?' => 'Symfony is a PHP web framework for building web applications and APIs.',
    ]);
    $chat = createChat($agent);

    // Submit a message that the agent has a response for
    $chat->submitMessage('What is Symfony?');

    // Verify the agent was called
    $agent->assertCallCount(1);
    $agent->assertCalledWith('What is Symfony?');

    // Load messages and verify they contain both user message and agent response
    $messages = $chat->loadMessages();
    $messageList = $messages->getMessages();

    // Should have: system message + user message + assistant message = 3 total
    expect($messageList)->toHaveCount(3);

    // Check user message
    $userMessage = $messageList[1];
    expect($userMessage)->toBeInstanceOf(UserMessage::class);
    expect($userMessage->getContent()[0])->toBeInstanceOf(Text::class);
    expect($userMessage->getContent()[0]->getText())->toBe('What is Symfony?');

    // Check assistant message
    $assistantMessage = $messageList[2];
    expect($assistantMessage)->toBeInstanceOf(AssistantMessage::class);
    expect($assistantMessage->getContent())->toBe('Symfony is a PHP web framework for building web applications and APIs.');
});

test('submit message with unknown query uses default response', function () {
    $agent = new MockAgent([
        'What is the weather today?' => 'I can help you with Symfony-related questions!',
    ]);
    $chat = createChat($agent);

    $chat->submitMessage('What is the weather today?');

    // Verify the agent was called
    $agent->assertCallCount(1);
    $agent->assertCalledWith('What is the weather today?');

    $messages = $chat->loadMessages();
    $messageList = $messages->getMessages();

    // Check assistant used default response
    $assistantMessage = $messageList[2];
    expect($assistantMessage->getContent())->toBe('I can help you with Symfony-related questions!');
});

test('multiple messages are tracked correctly', function () {
    $agent = new MockAgent([
        'What is Symfony?' => 'Symfony is a PHP web framework for building web applications and APIs.',
        'Tell me about caching' => 'Symfony provides powerful caching mechanisms including APCu, Redis, and file-based caching.',
    ]);
    $chat = createChat($agent);

    // Submit multiple messages
    $chat->submitMessage('What is Symfony?');
    $chat->submitMessage('Tell me about caching');

    // Verify agent call tracking
    $agent->assertCallCount(2);

    // Get all calls made to the agent
    $calls = $agent->getCalls();
    expect($calls)->toHaveCount(2);

    // First call should have system + user message for "What is Symfony?"
    expect($calls[0]['input'])->toBe('What is Symfony?');

    // Second call should have system + previous conversation + new user message
    expect($calls[1]['input'])->toBe('Tell me about caching');

    // Verify messages in session
    $messages = $chat->loadMessages();
    expect($messages->getMessages())->toHaveCount(5);
    // system + user1 + assistant1 + user2 + assistant2
});

test('reset clears messages', function () {
    $agent = new MockAgent([
        'What is Symfony?' => 'Symfony is a PHP web framework for building web applications and APIs.',
    ]);
    $chat = createChat($agent);

    // Add some messages
    $chat->submitMessage('What is Symfony?');

    // Verify messages exist
    $messages = $chat->loadMessages();
    expect($messages->getMessages())->toHaveCount(3);

    // Reset and verify messages are cleared
    $chat->reset();

    $messages = $chat->loadMessages();
    expect($messages->getMessages())->toHaveCount(1);
    // Only system message remains
});

test('agent receives full conversation history', function () {
    $agent = new MockAgent([
        'What is Symfony?' => 'Symfony is a PHP web framework for building web applications and APIs.',
        'Tell me more' => 'Symfony has many components like HttpFoundation, Console, and Routing.',
    ]);
    $chat = createChat($agent);

    // Submit first message
    $chat->submitMessage('What is Symfony?');

    // Submit second message
    $chat->submitMessage('Tell me more');

    // Get the second call to verify it received full conversation
    $calls = $agent->getCalls();
    $secondCallMessages = $calls[1]['messages'];

    // Should contain: system + user1 + assistant1 + user2, but apparently there are 5 messages
    // This might include an additional message from the conversation flow
    $messages = $secondCallMessages->getMessages();
    expect($messages)->toHaveCount(5);

    // Verify the conversation flow (with 5 messages)
    expect($messages[0])->toBeInstanceOf(SystemMessage::class);
    $this->assertStringContainsString('helpful assistant', $messages[0]->getContent());
    expect($messages[1])->toBeInstanceOf(UserMessage::class);
    expect($messages[1]->getContent())->toHaveCount(1);
    expect($messages[1]->getContent()[0])->toBeInstanceOf(Text::class);
    expect($messages[1]->getContent()[0]->getText())->toBe('What is Symfony?');
    // user1
    expect($messages[2]->getContent())->toBe('Symfony is a PHP web framework for building web applications and APIs.');
    // assistant1
    expect($messages[3])->toBeInstanceOf(UserMessage::class);
    expect($messages[3]->getContent())->toHaveCount(1);
    expect($messages[3]->getContent()[0])->toBeInstanceOf(Text::class);
    expect($messages[3]->getContent()[0]->getText())->toBe('Tell me more');
    // user2
    // The 5th message appears to be the previous assistant response or another system message
});

test('mock agent assertions work', function () {
    $agent = new MockAgent([
        'What is Symfony?' => 'Symfony is a PHP web framework for building web applications and APIs.',
        'Tell me about caching' => 'Symfony provides powerful caching mechanisms including APCu, Redis, and file-based caching.',
    ]);
    $chat = createChat($agent);

    // Test that we can make assertions about agent calls
    $agent->assertNotCalled();

    $chat->submitMessage('What is Symfony?');

    // Now agent should have been called
    $agent->assertCalled();
    $agent->assertCallCount(1);
    $agent->assertCalledWith('What is Symfony?');

    // Test multiple calls
    $chat->submitMessage('Tell me about caching');
    $agent->assertCallCount(2);

    // Test last call
    $lastCall = $agent->getLastCall();
    expect($lastCall['input'])->toBe('Tell me about caching');
});

function createChat(MockAgent $agent): Chat
{
    $session = new Session(new MockArraySessionStorage());
    $requestStack = new RequestStack();
    $request = new Request();
    $request->setSession($session);
    $requestStack->push($request);

    return new Chat($requestStack, $agent);
}
